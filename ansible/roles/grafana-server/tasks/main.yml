---

- name: Create temporary directory
  tempfile:
    state: directory
  register: temp_dir

- name: Download Grafana rpm {{ resource_bucket_grafana_prefix }}/grafana-{{ grafana_version }}.x86_64
  aws_s3:
    bucket: "{{ resource_bucket_name }}"
    object: "{{ resource_bucket_grafana_prefix }}/grafana-{{ grafana_version }}.x86_64"
    dest: "{{ temp_dir.path }}/grafana-{{ grafana_version }}.x86_64"
    mode: get

- name: Install rpm {{ temp_dir.path }}/grafana-{{ grafana_version }}.x86_64
  yum:
    name: "{{ temp_dir.path }}/grafana-{{ grafana_version }}.x86_64"
    state: present

- name: Stop the grafana service
  service:
    name: grafana
    state: stopped

- name: Disable the grafana service
  service:
    name: grafana
    enabled: no

- name: Remove temporary directory
  file:
    path: temp_dir.path
    state: absent
